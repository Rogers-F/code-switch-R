name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update version from tag
        id: version
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart('v')
          "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Updating version to: $VERSION"

          # Update version_service.go
          $content = Get-Content version_service.go -Raw
          $content = $content -replace 'const AppVersion = "v[^"]*"', "const AppVersion = `"v$VERSION`""
          Set-Content version_service.go $content
          Write-Host "Updated version_service.go:"
          Select-String "AppVersion" version_service.go

          # Update build/windows/info.json
          $json = Get-Content build/windows/info.json -Raw | ConvertFrom-Json
          $json.fixed.file_version = $VERSION
          $json.info.'0000'.ProductVersion = $VERSION
          $json | ConvertTo-Json -Depth 10 | Set-Content build/windows/info.json
          Write-Host "Updated build/windows/info.json:"
          Get-Content build/windows/info.json

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install frontend dependencies
        run: cd frontend && npm install

      - name: Install NSIS
        run: choco install nsis -y

      - name: Update build assets
        run: wails3 task common:update:build-assets

      - name: Generate bindings
        run: wails3 task common:generate:bindings

      - name: Build Windows Binary
        run: |
          $env:ARCH = "amd64"
          wails3 task windows:build
        env:
          PRODUCTION: "true"

      - name: Verify Binary
        run: |
          if (Test-Path "bin\CodeSwitch.exe") {
            Write-Host "✓ Binary found: bin\CodeSwitch.exe"
            Get-Item "bin\CodeSwitch.exe" | Format-List Name,Length,LastWriteTime
          } else {
            Write-Host "✗ Binary not found!"
            Write-Host "Listing bin directory:"
            Get-ChildItem bin -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Create NSIS Installer
        run: |
          $env:PATH += ";C:\Program Files (x86)\NSIS"
          Push-Location build\windows\nsis
          wails3 generate webview2bootstrapper
          $binaryPath = (Resolve-Path "..\..\..\bin\CodeSwitch.exe").Path
          Write-Host "Binary path: $binaryPath"
          makensis -DARG_WAILS_AMD64_BINARY="$binaryPath" project.nsi
          Pop-Location

      - name: Rename files with version
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          Push-Location bin
          Rename-Item "CodeSwitch.exe" "CodeSwitch-v$VERSION.exe"
          Pop-Location
          # Rename installer (generated by NSIS)
          if (Test-Path "build/windows/nsis/CodeSwitch-amd64-installer.exe") {
            Move-Item "build/windows/nsis/CodeSwitch-amd64-installer.exe" "bin/CodeSwitch-v$VERSION-amd64-installer.exe"
          } elseif (Test-Path "bin/CodeSwitch-amd64-installer.exe") {
            Rename-Item "bin/CodeSwitch-amd64-installer.exe" "CodeSwitch-v$VERSION-amd64-installer.exe"
          }
          Write-Host "Files renamed:"
          Get-ChildItem bin

      - name: Generate SHA256 Checksums
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          Push-Location bin
          Get-FileHash -Algorithm SHA256 "CodeSwitch-v$VERSION.exe" | ForEach-Object { "$($_.Hash.ToLower())  CodeSwitch-v$VERSION.exe" } | Out-File -Encoding ascii "CodeSwitch-v$VERSION.exe.sha256"
          Write-Host "SHA256 checksums generated:"
          Get-Content *.sha256
          Pop-Location

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: |
            bin/CodeSwitch-v${{ steps.version.outputs.VERSION }}-amd64-installer.exe
            bin/CodeSwitch-v${{ steps.version.outputs.VERSION }}.exe
            bin/CodeSwitch-v${{ steps.version.outputs.VERSION }}.exe.sha256

  create-release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Prepare release assets
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p release-assets

          # Windows
          cp artifacts/windows-amd64/CodeSwitch-v${VERSION}-amd64-installer.exe release-assets/
          cp artifacts/windows-amd64/CodeSwitch-v${VERSION}.exe release-assets/
          cp artifacts/windows-amd64/CodeSwitch-v${VERSION}.exe.sha256 release-assets/

          ls -lh release-assets/

      - name: Generate latest.json
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          python3 scripts/generate-latest-json.py "v${VERSION}" release-assets release-assets/latest.json
          echo "Generated latest.json:"
          cat release-assets/latest.json

      - name: Generate release body
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Generating release body for v$VERSION"

          # 提取当前版本的更新内容（从标题到下一个版本标题之前）
          # 注意：先用 tr 去除 Windows CRLF 换行符，否则 awk 匹配失败
          tr -d '\r' < RELEASE_NOTES.md | awk "/^# Code Switch v$VERSION/,/^# Code Switch v[0-9]/" | head -n -1 > /tmp/version_notes.md

          # 如果没找到版本说明，使用默认内容
          if [ ! -s /tmp/version_notes.md ]; then
            echo "## 更新亮点" > /tmp/version_notes.md
            echo "- 请查看提交历史了解详细更新" >> /tmp/version_notes.md
          fi

          # 组合完整的 release body
          cat /tmp/version_notes.md > /tmp/release_body.md

          cat >> /tmp/release_body.md << EOF

          ---

          ## 下载说明

          | 平台 | 文件 | 说明 |
          |------|------|------|
          | **Windows (首次)** | \`CodeSwitch-v${VERSION}-amd64-installer.exe\` | NSIS 安装器 |
          | **Windows (便携)** | \`CodeSwitch-v${VERSION}.exe\` | 直接运行 |

          ## 文件校验
          \`\`\`powershell
          Get-FileHash CodeSwitch-v${VERSION}.exe | Format-List
          \`\`\`
          EOF

          echo "Generated release body:"
          cat /tmp/release_body.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          body_path: /tmp/release_body.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
