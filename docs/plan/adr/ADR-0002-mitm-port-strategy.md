# ADR-0002: MITM 监听端口与转发策略（443 vs 8443 + 端口转发）

**状态**：Accepted
**日期**：2026-01-13
**决策日期**：2026-01-13  

---

## 背景

要通过 Hosts 把目标域名指向 `127.0.0.1` 并拦截 HTTPS，客户端会默认访问 443 端口。

但在 macOS/Linux 上，绑定 443 往往需要管理员/特权能力；如果强制要求“以管理员运行整个应用”，用户体验与安全边界会变差。

---

## 选项

### 方案 A：直接监听 443

**优点**：

- 实现直观，链路最短

**缺点**：

- macOS/Linux 需要提权运行（或额外能力），失败概率高
- 需要更严格的安全评估（长期特权进程）

### 方案 B：监听高位端口（如 8443）+ 系统端口转发（推荐）

**优点**：

- 应用主体可保持非特权运行
- 仅在需要时对“端口转发规则”提权，符合最小权限原则

**缺点**：

- 端口转发在不同 OS 上差异大（命令、持久化、回滚）
- 需要更完善的状态检查与自动清理

---

## 决策

在本项目里，**优先选择方案 A（直接监听 443）**，对齐参考项目 ghosxy 的工作方式，以满足核心目标：

- 支持“不支持自定义第三方 API 的 IDE”：只能通过 Hosts 劫持域名并访问 443，此时 MITM 必须在 443 接流量。
- 实现成本更低、链路更短，便于先把“规则命中 → 上游转发”做正确。

同时保留 **方案 B** 作为未来可选优化（降低长期特权运行的要求），但不作为当前阶段的默认实现。

---

## 影响

- P3：需要在 UI 明确提示“监听 443 需要管理员权限”，并给出失败后的可操作指引（如何以管理员权限重启应用）。
- P5：验证矩阵必须覆盖“无权限启动 MITM”的失败路径（提示清晰、不影响 Relay 模式）。
- （未来若启用方案 B）P3/P5 需补充端口转发 enable/disable/status 与回滚演练。
